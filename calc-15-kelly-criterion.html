<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kelly Criterion Calculator ‚Äî Finingale</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#0A1628;--navy2:#0E1F3D;--navy3:#162847;--navy4:#1a2f52;
  --gold:#C9A84C;--gold2:#E8C96B;--gold3:#f5e09a;
  --white:#F8F5EE;--grey:#8A95A3;--grey2:#5a6472;
  --green:#4ade80;--green2:#16a34a;
  --red:#f87171;--red2:#dc2626;
  --blue:#60a5fa;--purple:#c084fc;--yellow:#fbbf24;
}
body{font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--white);min-height:100vh;padding:40px 24px;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(201,168,76,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(201,168,76,0.03) 1px,transparent 1px);background-size:60px 60px;pointer-events:none;z-index:0;}
.wrapper{max-width:1100px;margin:0 auto;position:relative;z-index:1;}

/* Header */
.calc-header{margin-bottom:36px;}
.calc-tag{font-size:0.68rem;font-weight:600;letter-spacing:0.25em;text-transform:uppercase;color:var(--gold);display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.calc-tag::before{content:'';width:22px;height:1px;background:var(--gold);}
.calc-title{font-family:'Playfair Display',serif;font-size:clamp(1.8rem,3.5vw,2.8rem);font-weight:900;line-height:1.1;margin-bottom:8px;}
.calc-title span{color:var(--gold);}
.calc-desc{font-size:0.88rem;color:var(--grey);font-weight:300;max-width:660px;line-height:1.8;}

/* Tab Nav */
.tab-nav{display:flex;gap:4px;margin-bottom:24px;background:var(--navy2);border:1px solid rgba(201,168,76,0.13);border-radius:8px;padding:6px;}
.tab-btn{flex:1;padding:10px 16px;border:none;background:transparent;color:var(--grey);font-size:0.78rem;font-weight:600;font-family:'DM Sans',sans-serif;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;border-radius:5px;transition:all 0.2s;}
.tab-btn.active{background:var(--gold);color:var(--navy);}
.tab-btn:hover:not(.active){color:var(--gold);}
.tab-content{display:none;}
.tab-content.active{display:block;}

/* Layout */
.calc-body{display:grid;grid-template-columns:360px 1fr;gap:20px;align-items:start;}
@media(max-width:860px){.calc-body{grid-template-columns:1fr;}}

/* Panels */
.panel{background:var(--navy2);border:1px solid rgba(201,168,76,0.13);border-radius:8px;padding:28px;}
.panel+.panel{margin-top:20px;}
.panel-title{font-size:0.68rem;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:var(--gold);margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid rgba(201,168,76,0.12);}

/* Inputs */
.input-group{margin-bottom:20px;}
.input-label{font-size:0.7rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--grey);margin-bottom:6px;display:block;}
.input-hint{font-size:0.65rem;color:rgba(138,149,163,0.6);margin-bottom:6px;display:block;}
.input-wrap{position:relative;display:flex;align-items:center;}
.input-prefix{position:absolute;left:14px;font-size:0.88rem;font-weight:600;color:var(--gold);pointer-events:none;z-index:1;}
.input-suffix{position:absolute;right:14px;font-size:0.88rem;font-weight:500;color:var(--grey);pointer-events:none;z-index:1;}
.field{width:100%;padding:12px 14px;background:var(--navy3);border:1px solid rgba(201,168,76,0.18);border-radius:5px;color:var(--white);font-size:0.95rem;font-weight:500;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.2s,box-shadow 0.2s;-moz-appearance:textfield;}
.field::-webkit-outer-spin-button,.field::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.field:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,0.1);}
.field.has-prefix{padding-left:32px;}
.field.has-suffix{padding-right:40px;}
.field.error{border-color:var(--red);}
.error-msg{font-size:0.65rem;color:var(--red);margin-top:5px;display:none;}
.error-msg.show{display:block;}

/* Buttons */
.calc-btn{width:100%;margin-top:8px;padding:14px;background:var(--gold);color:var(--navy);font-size:0.85rem;font-weight:700;font-family:'DM Sans',sans-serif;letter-spacing:0.1em;text-transform:uppercase;border:none;border-radius:5px;cursor:pointer;transition:background 0.2s,transform 0.15s;}
.calc-btn:hover{background:var(--gold2);transform:translateY(-1px);}

/* Empty state */
.empty-state{text-align:center;padding:48px 20px;color:var(--grey);}
.empty-state-icon{font-size:2.8rem;margin-bottom:14px;opacity:0.4;}
.empty-state-text{font-size:0.85rem;line-height:1.7;}

/* Kelly output cards */
.kelly-trio{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;}
.kelly-card{border-radius:7px;padding:18px;text-align:center;position:relative;overflow:hidden;}
.kelly-card::before{content:'';position:absolute;inset:0;opacity:0.06;border-radius:inherit;}
.kelly-card.full{background:rgba(248,113,113,0.07);border:1px solid rgba(248,113,113,0.3);}
.kelly-card.half{background:rgba(201,168,76,0.09);border:1px solid rgba(201,168,76,0.4);}
.kelly-card.quarter{background:rgba(74,222,128,0.07);border:1px solid rgba(74,222,128,0.3);}
.kelly-card-badge{font-size:0.6rem;font-weight:700;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:6px;padding:3px 8px;border-radius:2px;display:inline-block;}
.kelly-card.full .kelly-card-badge{background:rgba(248,113,113,0.15);color:var(--red);}
.kelly-card.half .kelly-card-badge{background:rgba(201,168,76,0.15);color:var(--gold2);}
.kelly-card.quarter .kelly-card-badge{background:rgba(74,222,128,0.15);color:var(--green);}
.kelly-pct{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;margin:6px 0;}
.kelly-card.full .kelly-pct{color:var(--red);}
.kelly-card.half .kelly-pct{color:var(--gold2);}
.kelly-card.quarter .kelly-pct{color:var(--green);}
.kelly-desc{font-size:0.67rem;color:var(--grey);line-height:1.5;}

/* Recommendation banner */
.rec-banner{padding:14px 18px;border-radius:6px;font-size:0.82rem;font-weight:500;line-height:1.6;margin-bottom:18px;display:flex;gap:10px;align-items:flex-start;}
.rec-banner.rec-good{background:rgba(74,222,128,0.08);border:1px solid rgba(74,168,128,0.25);color:var(--green);}
.rec-banner.rec-warn{background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.25);color:var(--yellow);}
.rec-banner.rec-bad{background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.25);color:var(--red);}
.rec-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px;}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.stat-card{background:var(--navy3);border:1px solid rgba(201,168,76,0.1);border-radius:5px;padding:14px;}
.stat-label{font-size:0.62rem;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--grey);margin-bottom:5px;}
.stat-value{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:var(--white);}
.stat-value.good{color:var(--green);}
.stat-value.bad{color:var(--red);}
.stat-value.warn{color:var(--yellow);}
.stat-sub{font-size:0.63rem;color:var(--grey);margin-top:2px;}

/* Growth rate visual */
.growth-bars{margin-bottom:6px;}
.gb-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.gb-label{font-size:0.68rem;color:var(--grey);width:110px;flex-shrink:0;}
.gb-track{flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;}
.gb-fill{height:100%;border-radius:4px;transition:width 0.6s cubic-bezier(.4,0,.2,1);}
.gb-val{font-size:0.7rem;font-weight:600;width:60px;text-align:right;flex-shrink:0;}

/* Chart */
.chart-container{position:relative;height:280px;}

/* ‚îÄ‚îÄ TAB 2: SIMULATOR ‚îÄ‚îÄ */
.sim-body{display:grid;grid-template-columns:320px 1fr;gap:20px;align-items:start;}
@media(max-width:860px){.sim-body{grid-template-columns:1fr;}}
.sim-result-header{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
.sim-badge{padding:8px 14px;border-radius:4px;font-size:0.75rem;font-weight:700;text-align:center;flex:1;min-width:120px;}
.sim-badge.full-k{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);color:var(--red);}
.sim-badge.half-k{background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);color:var(--gold2);}
.sim-badge.double-k{background:rgba(192,132,252,0.1);border:1px solid rgba(192,132,252,0.3);color:var(--purple);}
.sim-badge.fixed{background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);color:var(--blue);}
.sim-badge-label{font-size:0.6rem;opacity:0.7;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.1em;}
.sim-badge-val{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:900;}
.sim-badge-sub{font-size:0.65rem;margin-top:2px;opacity:0.8;}
.sim-chart-container{position:relative;height:300px;margin-bottom:16px;}
.sim-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
@media(max-width:700px){.sim-stats{grid-template-columns:repeat(2,1fr);}}
.sim-stat{background:var(--navy3);border:1px solid rgba(201,168,76,0.08);border-radius:5px;padding:12px;text-align:center;}
.sim-stat-label{font-size:0.58rem;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--grey);margin-bottom:4px;}
.sim-stat-val{font-family:'Playfair Display',serif;font-size:0.95rem;font-weight:700;color:var(--white);}

/* ‚îÄ‚îÄ TAB 3: MULTI-ASSET ‚îÄ‚îÄ */
.multi-body{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:820px){.multi-body{grid-template-columns:1fr;}}
.asset-rows{display:flex;flex-direction:column;gap:10px;margin-bottom:14px;}
.asset-row{background:var(--navy3);border:1px solid rgba(201,168,76,0.12);border-radius:5px;padding:14px;}
.asset-row-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.asset-name{font-size:0.72rem;font-weight:700;color:var(--gold);}
.remove-asset{border:none;background:transparent;color:var(--grey);cursor:pointer;font-size:0.9rem;padding:2px 6px;border-radius:3px;transition:color 0.15s;}
.remove-asset:hover{color:var(--red);}
.asset-inputs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.asset-input-group{}
.asset-input-label{font-size:0.6rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--grey);margin-bottom:4px;display:block;}
.asset-field{width:100%;padding:8px 10px;background:var(--navy2);border:1px solid rgba(201,168,76,0.15);border-radius:4px;color:var(--white);font-size:0.82rem;font-family:'DM Sans',sans-serif;outline:none;-moz-appearance:textfield;}
.asset-field::-webkit-outer-spin-button,.asset-field::-webkit-inner-spin-button{-webkit-appearance:none;}
.asset-field:focus{border-color:var(--gold);}
.add-asset-btn{width:100%;padding:10px;border:1px dashed rgba(201,168,76,0.3);background:transparent;color:var(--gold);font-size:0.78rem;font-family:'DM Sans',sans-serif;border-radius:4px;cursor:pointer;transition:all 0.18s;margin-bottom:14px;}
.add-asset-btn:hover{background:rgba(201,168,76,0.06);border-style:solid;}
.multi-results-table{width:100%;border-collapse:collapse;font-size:0.76rem;margin-top:12px;}
.multi-results-table th{font-size:0.6rem;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--gold);padding:8px 10px;border-bottom:1px solid rgba(201,168,76,0.15);text-align:left;}
.multi-results-table td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,0.04);color:var(--grey);}
.multi-results-table td:first-child{color:var(--white);font-weight:600;}
.multi-results-table tr:hover td{background:rgba(201,168,76,0.03);}

/* Limitations box */
.limits-box{background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:6px;padding:18px;margin-top:20px;}
.limits-title{font-size:0.68rem;font-weight:600;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:12px;}
.limit-item{display:flex;gap:10px;margin-bottom:10px;font-size:0.78rem;color:var(--grey);line-height:1.6;}
.limit-item:last-child{margin-bottom:0;}
.limit-num{color:var(--gold);font-weight:700;flex-shrink:0;width:18px;}

/* Footer */
.calc-footer{margin-top:28px;padding-top:14px;border-top:1px solid rgba(201,168,76,0.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
.brand{font-family:'Playfair Display',serif;font-size:1rem;font-weight:900;}
.brand span{color:var(--gold);}
.disclaimer{font-size:0.67rem;color:var(--grey);}
</style>
</head>
<body>
<div class="wrapper">

  <div class="calc-header">
    <div class="calc-tag">Calculator 15 ¬∑ Finingale</div>
    <h1 class="calc-title">Kelly Criterion <span>Calculator</span></h1>
    <p class="calc-desc">Developed by John Kelly Jr. at Bell Labs in 1956 ‚Äî the mathematically optimal position sizing formula that maximises long-term geometric growth while protecting against ruin. The counterpart to the Martingale strategy.</p>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('basic',this)">üìê Kelly Calculator</button>
    <button class="tab-btn" onclick="switchTab('sim',this)">üé≤ Strategy Simulator</button>
    <button class="tab-btn" onclick="switchTab('multi',this)">üìä Multi-Asset Kelly</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 1: BASIC KELLY CALCULATOR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-basic" class="tab-content active">
    <div class="calc-body">
      <div>
        <div class="panel">
          <div class="panel-title">Strategy Parameters</div>
          <div class="input-group">
            <label class="input-label">Win Probability</label>
            <span class="input-hint">Estimated probability of a winning trade (from backtesting)</span>
            <div class="input-wrap"><input type="number" id="win-prob" class="field has-suffix" placeholder="e.g. 55" min="1" max="99" step="any"/><span class="input-suffix">%</span></div>
            <div class="error-msg" id="err-win-prob">Please enter between 1 and 99</div>
          </div>
          <div class="input-group">
            <label class="input-label">Average Win Size</label>
            <span class="input-hint">Average gain per winning trade (e.g. 2.5 means +2.5%)</span>
            <div class="input-wrap"><input type="number" id="avg-win" class="field has-suffix" placeholder="e.g. 2.5" min="0.01" step="any"/><span class="input-suffix">%</span></div>
            <div class="error-msg" id="err-avg-win">Please enter a valid win size</div>
          </div>
          <div class="input-group">
            <label class="input-label">Average Loss Size</label>
            <span class="input-hint">Average loss per losing trade (e.g. 1.5 means ‚àí1.5%)</span>
            <div class="input-wrap"><input type="number" id="avg-loss" class="field has-suffix" placeholder="e.g. 1.5" min="0.01" step="any"/><span class="input-suffix">%</span></div>
            <div class="error-msg" id="err-avg-loss">Please enter a valid loss size</div>
          </div>
          <div class="input-group" style="margin-bottom:16px;">
            <label class="input-label">Starting Capital (Optional)</label>
            <span class="input-hint">Used to show actual dollar amounts</span>
            <div class="input-wrap"><span class="input-prefix">$</span><input type="number" id="capital" class="field has-prefix" placeholder="e.g. 100000" min="0" step="any"/></div>
          </div>
          <button class="calc-btn" onclick="calcKelly()">Calculate ‚Üí</button>
        </div>
      </div>

      <div>
        <div class="panel">
          <div class="panel-title">Kelly Results</div>
          <div class="empty-state" id="basic-empty">
            <div class="empty-state-icon">‚öñÔ∏è</div>
            <div class="empty-state-text">Enter your strategy's win rate and average win/loss sizes<br/>to find the mathematically optimal position size.</div>
          </div>
          <div id="basic-results" style="display:none;">
            <!-- Three Kelly variants -->
            <div class="kelly-trio">
              <div class="kelly-card full">
                <div class="kelly-card-badge">Full Kelly</div>
                <div class="kelly-pct" id="k-full">‚Äî</div>
                <div class="kelly-desc">Theoretically optimal. In practice, drawdowns are severe. Use only if you have 100% confidence in your edge estimates.</div>
              </div>
              <div class="kelly-card half">
                <div class="kelly-card-badge">¬Ω Kelly ‚ú¶ Recommended</div>
                <div class="kelly-pct" id="k-half">‚Äî</div>
                <div class="kelly-desc">75% of optimal growth rate with 50% less volatility. The professional standard for most traders.</div>
              </div>
              <div class="kelly-card quarter">
                <div class="kelly-card-badge">¬º Kelly</div>
                <div class="kelly-pct" id="k-quarter">‚Äî</div>
                <div class="kelly-desc">Conservative. Ideal when uncertain about probability estimates. Captures ~56% of optimal growth.</div>
              </div>
            </div>

            <!-- Recommendation -->
            <div class="rec-banner" id="rec-banner">
              <span class="rec-icon">‚Äî</span>
              <span id="rec-text">‚Äî</span>
            </div>

            <!-- Key stats -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Expected Value per Trade</div>
                <div class="stat-value" id="stat-ev">‚Äî</div>
                <div class="stat-sub">Per unit risked</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Win / Loss Ratio (b)</div>
                <div class="stat-value" id="stat-b">‚Äî</div>
                <div class="stat-sub">Avg win √∑ avg loss</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Dollar Risk (¬Ω Kelly)</div>
                <div class="stat-value" id="stat-dollar">‚Äî</div>
                <div class="stat-sub" id="stat-dollar-sub">On your capital</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Ruin at 2√ó Kelly</div>
                <div class="stat-value bad">Negative growth</div>
                <div class="stat-sub">Betting above Kelly kills returns</div>
              </div>
            </div>

            <!-- Growth rate comparison bars -->
            <div style="font-size:0.65rem;font-weight:600;letter-spacing:0.15em;text-transform:uppercase;color:var(--gold);margin-bottom:10px;">Growth Rate vs Position Size</div>
            <div class="growth-bars" id="growth-bars"></div>
          </div>
        </div>

        <div class="panel" id="basic-chart-panel" style="display:none;">
          <div class="panel-title">Kelly Growth Curve ‚Äî Optimal vs Over/Under Betting</div>
          <div class="chart-container"><canvas id="kellyChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 2: SIMULATOR
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-sim" class="tab-content">
    <div class="sim-body">
      <div>
        <div class="panel">
          <div class="panel-title">Simulation Setup</div>
          <div class="input-group">
            <label class="input-label">Win Probability</label>
            <span class="input-hint">Probability of each trade winning</span>
            <div class="input-wrap"><input type="number" id="s-win-prob" class="field has-suffix" placeholder="e.g. 55" min="1" max="99" step="any"/><span class="input-suffix">%</span></div>
          </div>
          <div class="input-group">
            <label class="input-label">Win / Loss Ratio</label>
            <span class="input-hint">Average win size √∑ average loss size</span>
            <div class="input-wrap"><input type="number" id="s-ratio" class="field" placeholder="e.g. 1.5" min="0.01" step="any"/></div>
          </div>
          <div class="input-group">
            <label class="input-label">Number of Trades</label>
            <span class="input-hint">How many trades to simulate</span>
            <div class="input-wrap"><input type="number" id="s-trades" class="field" placeholder="e.g. 200" min="20" max="1000" step="1"/></div>
          </div>
          <div class="input-group" style="margin-bottom:16px;">
            <label class="input-label">Starting Capital</label>
            <div class="input-wrap"><span class="input-prefix">$</span><input type="number" id="s-capital" class="field has-prefix" placeholder="e.g. 100000" min="1" step="any"/></div>
          </div>
          <button class="calc-btn" onclick="runSimulation()">Run Simulation ‚Üí</button>
          <button class="calc-btn" style="margin-top:8px;background:transparent;border:1px solid rgba(201,168,76,0.3);color:var(--gold);" onclick="runSimulation()">Re-run ‚Ü∫</button>
        </div>

        <div class="panel" style="margin-top:20px;">
          <div class="panel-title">What This Shows</div>
          <div style="font-size:0.78rem;color:var(--grey);line-height:1.8;">
            All four strategies use the <em style="color:var(--white);">exact same sequence</em> of winning and losing trades ‚Äî so results differ purely due to position sizing, not luck.<br/><br/>
            <span style="color:var(--red);">‚ñ†</span> <strong style="color:var(--white);">Full Kelly</strong> ‚Äî mathematically optimal but volatile<br/>
            <span style="color:var(--gold2);">‚ñ†</span> <strong style="color:var(--white);">Half Kelly</strong> ‚Äî the professional standard<br/>
            <span style="color:var(--purple);">‚ñ†</span> <strong style="color:var(--white);">2√ó Kelly</strong> ‚Äî over-betting, provably sub-optimal<br/>
            <span style="color:var(--blue);">‚ñ†</span> <strong style="color:var(--white);">Fixed 2%</strong> ‚Äî flat position sizing for comparison
          </div>
        </div>
      </div>

      <div>
        <div class="panel">
          <div class="panel-title">Simulation Results</div>
          <div class="empty-state" id="sim-empty">
            <div class="empty-state-icon">üìà</div>
            <div class="empty-state-text">Configure your strategy on the left and click<br/><strong style="color:var(--gold)">Run Simulation</strong> to compare all four approaches.</div>
          </div>
          <div id="sim-results" style="display:none;">
            <div class="sim-result-header">
              <div class="sim-badge full-k"><div class="sim-badge-label">Full Kelly</div><div class="sim-badge-val" id="sr-full">‚Äî</div><div class="sim-badge-sub" id="sr-full-pct">‚Äî</div></div>
              <div class="sim-badge half-k"><div class="sim-badge-label">¬Ω Kelly</div><div class="sim-badge-val" id="sr-half">‚Äî</div><div class="sim-badge-sub" id="sr-half-pct">‚Äî</div></div>
              <div class="sim-badge double-k"><div class="sim-badge-label">2√ó Kelly</div><div class="sim-badge-val" id="sr-double">‚Äî</div><div class="sim-badge-sub" id="sr-double-pct">‚Äî</div></div>
              <div class="sim-badge fixed"><div class="sim-badge-label">Fixed 2%</div><div class="sim-badge-val" id="sr-fixed">‚Äî</div><div class="sim-badge-sub" id="sr-fixed-pct">‚Äî</div></div>
            </div>
            <div class="sim-chart-container"><canvas id="simChart"></canvas></div>
            <div class="sim-stats">
              <div class="sim-stat"><div class="sim-stat-label">Kelly Fraction</div><div class="sim-stat-val" id="ss-kelly">‚Äî</div></div>
              <div class="sim-stat"><div class="sim-stat-label">Trades Simulated</div><div class="sim-stat-val" id="ss-trades">‚Äî</div></div>
              <div class="sim-stat"><div class="sim-stat-label">Actual Win Rate</div><div class="sim-stat-val" id="ss-winrate">‚Äî</div></div>
              <div class="sim-stat"><div class="sim-stat-label">Win / Loss Ratio</div><div class="sim-stat-val" id="ss-ratio">‚Äî</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 3: MULTI-ASSET
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-multi" class="tab-content">
    <div class="multi-body">
      <div>
        <div class="panel">
          <div class="panel-title">Portfolio Positions</div>
          <p style="font-size:0.75rem;color:var(--grey);margin-bottom:16px;line-height:1.7;">Enter each strategy or asset separately. The total Kelly allocation shows how much of your total capital to allocate across the portfolio.</p>
          <div class="asset-rows" id="asset-rows"></div>
          <button class="add-asset-btn" onclick="addAsset()">+ Add Another Strategy / Asset</button>
          <button class="calc-btn" onclick="calcMultiKelly()">Calculate Portfolio Kelly ‚Üí</button>
        </div>
      </div>

      <div>
        <div class="panel">
          <div class="panel-title">Portfolio Allocation Results</div>
          <div class="empty-state" id="multi-empty">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-text">Add your strategies on the left and click<br/><strong style="color:var(--gold)">Calculate Portfolio Kelly</strong>.</div>
          </div>
          <div id="multi-results" style="display:none;">
            <div class="stat-card" style="margin-bottom:14px;text-align:center;border-color:rgba(201,168,76,0.3);background:rgba(201,168,76,0.07);">
              <div class="stat-label">Total Portfolio Kelly Allocation</div>
              <div style="font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--gold2);margin:6px 0;" id="total-kelly">‚Äî</div>
              <div class="stat-sub" id="total-kelly-sub">‚Äî</div>
            </div>
            <table class="multi-results-table">
              <thead><tr><th>Strategy</th><th>Kelly %</th><th>¬Ω Kelly</th><th>EV/Trade</th><th>Sizing ($)</th></tr></thead>
              <tbody id="multi-tbody"></tbody>
            </table>
            <div style="margin-top:14px;font-size:0.72rem;color:var(--grey);line-height:1.7;padding:12px;background:rgba(255,255,255,0.03);border-radius:4px;">
              ‚ö†Ô∏è <strong style="color:var(--white);">Note:</strong> This assumes strategies are independent. If positions are correlated, the true Kelly fraction is lower. Use correlation-adjusted Kelly for correlated assets.
            </div>
          </div>
        </div>

        <!-- Limitations -->
        <div class="limits-box">
          <div class="limits-title">‚ö† Known Limitations of Kelly</div>
          <div class="limit-item"><span class="limit-num">1</span><span>You never truly know p or b ‚Äî estimated probabilities from backtests are imprecise, and live edges differ from historical ones. Overestimation is common and dangerous.</span></div>
          <div class="limit-item"><span class="limit-num">2</span><span>Kelly assumes independent, identically distributed bets. Real markets have autocorrelation, fat tails, and regime changes that violate this assumption.</span></div>
          <div class="limit-item"><span class="limit-num">3</span><span>Full Kelly produces psychologically unbearable drawdowns ‚Äî you can expect your bankroll to halve before doubling ~33% of the time. Most investors abandon the strategy during this drawdown.</span></div>
          <div class="limit-item"><span class="limit-num">4</span><span>Kelly ignores transaction costs, slippage, and taxes. Real-world edges are almost always smaller than backtested edges, which means you should use a smaller fraction.</span></div>
          <div class="limit-item"><span class="limit-num">5</span><span>Betting even slightly above Kelly produces negative long-run growth. The upside is bounded; the downside is not. This asymmetry makes overconfidence very costly.</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="calc-footer">
    <div class="brand">Fining<span>ale</span></div>
    <div class="disclaimer">For educational purposes only. Past strategy performance does not guarantee future results.</div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTILITIES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt  = n => '$' + Math.round(n).toLocaleString('en-US');
const fmtD = n => '$' + parseFloat(n.toFixed(2)).toLocaleString('en-US', {minimumFractionDigits:2});
const fmtP = (n, d=2) => n.toFixed(d) + '%';
let basicChart = null, simChart = null;

function switchTab(id, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  btn.classList.add('active');
}

function showError(id, show) {
  const el = document.getElementById('err-' + id);
  const field = document.getElementById(id);
  if (!el) return;
  show ? (el.classList.add('show'), field && field.classList.add('error'))
       : (el.classList.remove('show'), field && field.classList.remove('error'));
}

// Kelly formula: f* = p - (1-p)/b
function kelly(p, b) { return p - (1 - p) / b; }

// Expected log growth rate per trade
function logGrowth(f, p, b) {
  if (f <= 0) return 0;
  const win  = 1 + f * b;
  const lose = 1 - f;
  if (lose <= 0) return -Infinity;
  return p * Math.log(win) + (1 - p) * Math.log(lose);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB 1: BASIC KELLY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcKelly() {
  const p    = parseFloat(document.getElementById('win-prob').value) / 100;
  const wPct = parseFloat(document.getElementById('avg-win').value);
  const lPct = parseFloat(document.getElementById('avg-loss').value);
  const cap  = parseFloat(document.getElementById('capital').value) || 0;

  let valid = true;
  if (isNaN(p) || p <= 0 || p >= 1)       { showError('win-prob', true); valid = false; } else showError('win-prob', false);
  if (isNaN(wPct) || wPct <= 0)            { showError('avg-win',  true); valid = false; } else showError('avg-win',  false);
  if (isNaN(lPct) || lPct <= 0)            { showError('avg-loss', true); valid = false; } else showError('avg-loss', false);
  if (!valid) return;

  const b  = wPct / lPct;         // win/loss ratio
  const q  = 1 - p;
  const kf = kelly(p, b);         // full kelly fraction
  const ev = p * b - q;           // EV per unit risked

  document.getElementById('basic-empty').style.display   = 'none';
  document.getElementById('basic-results').style.display = 'block';
  document.getElementById('basic-chart-panel').style.display = 'block';

  // Show Kelly values
  const fullPct = Math.max(0, kf * 100);
  document.getElementById('k-full').textContent    = fmtP(fullPct);
  document.getElementById('k-half').textContent    = fmtP(fullPct / 2);
  document.getElementById('k-quarter').textContent = fmtP(fullPct / 4);

  // Stats
  document.getElementById('stat-ev').textContent  = ev.toFixed(4);
  document.getElementById('stat-ev').className    = 'stat-value ' + (ev > 0 ? 'good' : 'bad');
  document.getElementById('stat-b').textContent   = b.toFixed(4);

  if (cap > 0) {
    document.getElementById('stat-dollar').textContent = fmt(cap * kf / 2);
    document.getElementById('stat-dollar-sub').textContent = `Risk ${fmtP(fullPct/2)} of ${fmt(cap)}`;
  } else {
    document.getElementById('stat-dollar').textContent = '‚Äî';
    document.getElementById('stat-dollar-sub').textContent = 'Enter capital above';
  }

  // Recommendation banner
  const banner = document.getElementById('rec-banner');
  const recText = document.getElementById('rec-text');
  if (ev <= 0) {
    banner.className = 'rec-banner rec-bad';
    document.querySelector('#rec-banner .rec-icon').textContent = '‚ùå';
    recText.textContent = 'Negative expectancy ‚Äî Kelly returns 0% or negative. Do not trade this strategy. Fix your edge first.';
  } else if (fullPct > 30) {
    banner.className = 'rec-banner rec-warn';
    document.querySelector('#rec-banner .rec-icon').textContent = '‚ö†Ô∏è';
    recText.textContent = `Full Kelly (${fmtP(fullPct)}) is very aggressive. Use Half Kelly (${fmtP(fullPct/2)}) ‚Äî you'll capture 75% of the growth with far lower drawdowns. Be cautious with high Kelly fractions as they assume your edge estimates are perfect.`;
  } else {
    banner.className = 'rec-banner rec-good';
    document.querySelector('#rec-banner .rec-icon').textContent = '‚úÖ';
    recText.textContent = `Half Kelly recommendation: risk ${fmtP(fullPct/2)} of your capital per trade. This gives approximately 75% of maximum growth rate with 50% less volatility than Full Kelly.`;
  }

  // Growth rate bars
  const scenarios = [
    { label: '¬º Kelly ('  + fmtP(fullPct/4,1) + ')',  f: kf * 0.25, color: '#4ade80' },
    { label: '¬Ω Kelly ('  + fmtP(fullPct/2,1) + ')',  f: kf * 0.5,  color: '#E8C96B' },
    { label: 'Full Kelly (' + fmtP(fullPct,1) + ')',  f: kf,        color: '#f87171' },
    { label: '2√ó Kelly ('  + fmtP(fullPct*2,1) + ')', f: kf * 2,    color: '#c084fc' },
  ];
  const maxGrowth = logGrowth(kf, p, b);
  const barsDiv = document.getElementById('growth-bars');
  barsDiv.innerHTML = scenarios.map(s => {
    const g = logGrowth(s.f, p, b);
    const pct = maxGrowth > 0 ? Math.max(0, g / maxGrowth * 100) : 0;
    return `<div class="gb-row">
      <div class="gb-label">${s.label}</div>
      <div class="gb-track"><div class="gb-fill" style="width:${pct.toFixed(1)}%;background:${s.color};"></div></div>
      <div class="gb-val" style="color:${s.color};">${(g * 100).toFixed(3)}%</div>
    </div>`;
  }).join('');

  // Kelly Growth Curve Chart
  const fractions = [], growthRates = [];
  for (let f = 0; f <= Math.min(kf * 3, 1); f += kf * 3 / 60) {
    fractions.push((f * 100).toFixed(1) + '%');
    growthRates.push(parseFloat((logGrowth(f, p, b) * 100).toFixed(5)));
  }
  const kellyIdx = fractions.findIndex(f => parseFloat(f) >= fullPct * 0.98);

  const ctx = document.getElementById('kellyChart').getContext('2d');
  const gradGold = ctx.createLinearGradient(0, 0, 0, 280);
  gradGold.addColorStop(0, 'rgba(201,168,76,0.35)');
  gradGold.addColorStop(1, 'rgba(201,168,76,0.02)');

  if (basicChart) basicChart.destroy();
  basicChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: fractions,
      datasets: [{
        label: 'Log Growth Rate',
        data: growthRates,
        borderColor: '#C9A84C',
        backgroundColor: gradGold,
        borderWidth: 2.5,
        fill: true,
        tension: 0.4,
        pointRadius: 0,
        pointHoverRadius: 5
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 700, easing: 'easeInOutQuart' },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0E1F3D',
          borderColor: 'rgba(201,168,76,0.3)',
          borderWidth: 1,
          titleColor: '#C9A84C',
          bodyColor: '#F8F5EE',
          padding: 12,
          callbacks: {
            title: items => 'Position Size: ' + items[0].label,
            label: c => ' Growth Rate: ' + c.raw + '%'
          }
        },
        annotation: {}
      },
      scales: {
        x: {
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { color: '#8A95A3', font: { family: 'DM Sans', size: 9 }, maxTicksLimit: 10 },
          title: { display: true, text: 'Position Size (% of capital)', color: '#8A95A3', font: { family: 'DM Sans', size: 10 } }
        },
        y: {
          grid: { color: 'rgba(255,255,255,0.04)' },
          ticks: { color: '#8A95A3', font: { family: 'DM Sans', size: 10 }, callback: v => v.toFixed(3) + '%' },
          title: { display: true, text: 'Expected Log Growth per Trade', color: '#8A95A3', font: { family: 'DM Sans', size: 10 } }
        }
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB 2: SIMULATOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runSimulation() {
  const p       = parseFloat(document.getElementById('s-win-prob').value) / 100;
  const b       = parseFloat(document.getElementById('s-ratio').value);
  const trades  = parseInt(document.getElementById('s-trades').value);
  const capital = parseFloat(document.getElementById('s-capital').value);
  if (isNaN(p)||p<=0||p>=1||isNaN(b)||b<=0||isNaN(trades)||trades<20||isNaN(capital)||capital<=0) {
    alert('Please fill in all simulation fields correctly.'); return;
  }

  const kf = Math.max(0, kelly(p, b));

  // Generate ONE sequence of outcomes shared across all strategies
  const outcomes = Array.from({ length: trades }, () => Math.random() < p);
  const wins  = outcomes.filter(Boolean).length;

  function simulate(fraction) {
    let bal = capital;
    const history = [capital];
    for (const won of outcomes) {
      const bet = bal * fraction;
      bal = won ? bal + bet * b : bal - bet;
      history.push(Math.max(0, bal));
      if (bal <= 0) { while (history.length <= trades) history.push(0); break; }
    }
    return history;
  }

  const fullHist   = simulate(kf);
  const halfHist   = simulate(kf * 0.5);
  const doubleHist = simulate(kf * 2);
  const fixedHist  = simulate(0.02);

  const last = h => h[h.length - 1];
  const pnlPct = h => ((last(h) - capital) / capital * 100).toFixed(1) + '%';

  document.getElementById('sim-empty').style.display    = 'none';
  document.getElementById('sim-results').style.display  = 'block';

  document.getElementById('sr-full').textContent    = fmt(last(fullHist));
  document.getElementById('sr-full-pct').textContent = pnlPct(fullHist);
  document.getElementById('sr-half').textContent    = fmt(last(halfHist));
  document.getElementById('sr-half-pct').textContent = pnlPct(halfHist);
  document.getElementById('sr-double').textContent  = fmt(last(doubleHist));
  document.getElementById('sr-double-pct').textContent = pnlPct(doubleHist);
  document.getElementById('sr-fixed').textContent   = fmt(last(fixedHist));
  document.getElementById('sr-fixed-pct').textContent = pnlPct(fixedHist);

  document.getElementById('ss-kelly').textContent   = fmtP(kf * 100);
  document.getElementById('ss-trades').textContent  = trades;
  document.getElementById('ss-winrate').textContent = fmtP(wins / trades * 100);
  document.getElementById('ss-ratio').textContent   = b.toFixed(2);

  const labels = Array.from({ length: trades + 1 }, (_, i) => i);
  const ctx2 = document.getElementById('simChart').getContext('2d');

  const makeGrad = (color, alpha1, alpha2) => {
    const g = ctx2.createLinearGradient(0, 0, 0, 300);
    g.addColorStop(0, color.replace(')', `,${alpha1})`).replace('rgb', 'rgba'));
    g.addColorStop(1, color.replace(')', `,${alpha2})`).replace('rgb', 'rgba'));
    return g;
  };

  if (simChart) simChart.destroy();
  simChart = new Chart(ctx2, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Full Kelly',   data: fullHist,   borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.05)', borderWidth: 2,   fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 },
        { label: '¬Ω Kelly',      data: halfHist,   borderColor: '#E8C96B', backgroundColor: 'rgba(232,201,107,0.08)', borderWidth: 2.5, fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 },
        { label: '2√ó Kelly',     data: doubleHist, borderColor: '#c084fc', backgroundColor: 'rgba(192,132,252,0.05)', borderWidth: 2,   fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 4 },
        { label: 'Fixed 2%',     data: fixedHist,  borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.05)',  borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0, pointHoverRadius: 4, borderDash: [5,3] },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 600, easing: 'easeInOutQuart' },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#8A95A3', font: { family: 'DM Sans', size: 11 }, boxWidth: 12 } },
        tooltip: {
          backgroundColor: '#0E1F3D', borderColor: 'rgba(201,168,76,0.3)', borderWidth: 1,
          titleColor: '#C9A84C', bodyColor: '#F8F5EE', padding: 12,
          callbacks: { title: i => 'Trade #' + i[0].label, label: c => ' ' + c.dataset.label + ': ' + fmt(c.raw) }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#8A95A3', font: { family: 'DM Sans', size: 10 }, maxTicksLimit: 10 }, title: { display: true, text: 'Trade #', color: '#8A95A3', font: { family: 'DM Sans', size: 10 } } },
        y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#8A95A3', font: { family: 'DM Sans', size: 10 }, callback: v => '$' + (v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'K' : v) } }
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TAB 3: MULTI-ASSET
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let assetCount = 0;

function addAsset(defaults = {}) {
  assetCount++;
  const id = assetCount;
  const row = document.createElement('div');
  row.className = 'asset-row';
  row.id = 'asset-' + id;
  row.innerHTML = `
    <div class="asset-row-header">
      <div class="asset-name">Strategy / Asset ${id}</div>
      <button class="remove-asset" onclick="document.getElementById('asset-${id}').remove()">‚úï</button>
    </div>
    <div class="asset-inputs">
      <div class="asset-input-group">
        <label class="asset-input-label">Win Rate %</label>
        <input type="number" class="asset-field a-wp" placeholder="e.g. 55" min="1" max="99" step="any" value="${defaults.wp||''}"/>
      </div>
      <div class="asset-input-group">
        <label class="asset-input-label">Avg Win %</label>
        <input type="number" class="asset-field a-aw" placeholder="e.g. 2.5" min="0.01" step="any" value="${defaults.aw||''}"/>
      </div>
      <div class="asset-input-group">
        <label class="asset-input-label">Avg Loss %</label>
        <input type="number" class="asset-field a-al" placeholder="e.g. 1.5" min="0.01" step="any" value="${defaults.al||''}"/>
      </div>
    </div>
  `;
  document.getElementById('asset-rows').appendChild(row);
}

function calcMultiKelly() {
  const rows = document.querySelectorAll('.asset-row');
  if (rows.length === 0) { alert('Please add at least one strategy.'); return; }

  const cap = parseFloat(document.getElementById('capital').value) || 100000;
  const results = [];

  rows.forEach((row, i) => {
    const wp = parseFloat(row.querySelector('.a-wp').value) / 100;
    const aw = parseFloat(row.querySelector('.a-aw').value);
    const al = parseFloat(row.querySelector('.a-al').value);
    if (isNaN(wp) || isNaN(aw) || isNaN(al) || wp <= 0 || aw <= 0 || al <= 0) return;
    const b   = aw / al;
    const kf  = Math.max(0, kelly(wp, b));
    const ev  = wp * b - (1 - wp);
    results.push({ name: `Strategy ${i+1}`, wp, aw, al, b, kf, ev });
  });

  if (results.length === 0) { alert('Please enter valid values for at least one strategy.'); return; }

  const totalKelly = results.reduce((s, r) => s + r.kf, 0);

  document.getElementById('multi-empty').style.display   = 'none';
  document.getElementById('multi-results').style.display = 'block';

  document.getElementById('total-kelly').textContent    = fmtP(totalKelly * 100);
  document.getElementById('total-kelly-sub').textContent = totalKelly > 1
    ? '‚ö† Total exceeds 100% ‚Äî consider scaling down proportionally'
    : totalKelly > 0.5
    ? '‚ö† Aggressive total allocation ‚Äî consider using Half Kelly'
    : '‚úÖ Reasonable total allocation';

  document.getElementById('multi-tbody').innerHTML = results.map(r => `
    <tr>
      <td>${r.name}</td>
      <td style="color:${r.kf>0?'#f87171':'#4ade80'}">${fmtP(r.kf*100)}</td>
      <td style="color:#E8C96B">${fmtP(r.kf*50)}</td>
      <td style="color:${r.ev>0?'#4ade80':'#f87171'}">${r.ev.toFixed(4)}</td>
      <td style="color:#60a5fa">${fmt(cap * r.kf * 0.5)}</td>
    </tr>
  `).join('');
}

// Init multi-asset with 2 default rows
addAsset({ wp: 55, aw: 2.5, al: 1.5 });
addAsset({ wp: 48, aw: 3.0, al: 1.0 });

// Enter key support
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('tab-basic').classList.contains('active')) calcKelly();
  if (e.key === 'Enter' && document.getElementById('tab-sim').classList.contains('active')) runSimulation();
});
</script>
</body>
</html>
